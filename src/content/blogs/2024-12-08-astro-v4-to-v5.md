---
title: Astro v4 to v5
description: Astro v4 ã‹ã‚‰ v5 ã¾ã§ã«è¿½åŠ ã•ã‚ŒãŸå€‹äººçš„ã«æ³¨ç›®ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
category: tech
author: miyaji
tags: ["advent-calendar", "javascript", "typescript", "astro"]
---

ã“ã®è¨˜äº‹ã¯ [OUCC Advent Calendar 2024](https://adventar.org/calendars/10655) ã® 8 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚æ˜¨æ—¥ã®è¨˜äº‹ã¯ã¾ã æŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“ ğŸ¤”
æœ¬æ—¥ã¯ã€Astro v4 ã‹ã‚‰ v5 ã¾ã§ã«è¿½åŠ ã•ã‚ŒãŸå€‹äººçš„ã«æ³¨ç›®ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã«ã¯ä»¥ä¸‹ã®å†…å®¹ã¯å«ã¾ã‚Œã¾ã›ã‚“

- ç ´å£Šçš„å¤‰æ›´ã®èª¬æ˜
- è©³ç´°ãªèª¬æ˜
- å®Œå…¨ãªç†è§£

## ä¸»è¦ãªæ–°æ©Ÿèƒ½

ã¾ãšã€Astroãƒ–ãƒ­ã‚°ã§ã‚‚å–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã‚‹ä¸»è¦ãªæ–°æ©Ÿèƒ½ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

### Content Layer

Astro v5 ã§ã¯ Content collections ãŒå¤§å¹…ã«å¤‰æ›´ã•ã‚Œã¦ Content Layer ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ¼ãƒ€ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã©ã“ã‹ã‚‰ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã™ã€‚
å¾“æ¥ã®`type`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ãŸ Content ã®æŒ‡å®šæ–¹æ³•ã¯å»ƒæ­¢ã•ã‚Œã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€çµ„ã¿è¾¼ã¿ã®ãƒ­ãƒ¼ãƒ€ãƒ¼é–¢æ•°ãŒæä¾›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```typescript
// src/content.config.ts
import { defineCollection, z } from 'astro:content';
import { glob } from 'astro/loaders';
import { notionLoader } from "notion-astro-loader";

const blog = defineCollection({
  // Load data from Markdown files on disk
  loader: glob({ pattern: "**/*.md", base: "./src/data/blog" }),
  schema: z.object({ /* optionally define a schema for type-safe data */  }),
});

const database = defineCollection({
  // Automatically fetch content in one line with a loader
  loader: notionLoader({ /* ... */ })
});

export const collections = { blog, database };
```

ã“ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯Storyblok ã‚„ Cloudinary ãªã©ã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã‚‚æä¾›ã•ã‚Œã¦ãŠã‚Šã€ç°¡å˜ã«å¤–éƒ¨ã®CMSã¨é€£æºã§ãã¾ã™ã€‚

Content Loaderã«ã¤ã„ã¦ã®ã•ã‚‰ãªã‚‹æƒ…å ±ã¯[å…¬å¼ã‚µã‚¤ãƒˆ](https://docs.astro.build/ja/reference/content-loader-reference/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

å¾“æ¥ã® Content collections ã¯ [Legacy flag]((https://docs.astro.build/ja/reference/legacy-flags/#collections)) ã‚’ã¤ã‘ã‚‹ã¨å¼•ãç¶šãä½¿ç”¨ã§ãã¾ã™ã€‚ãŸã ã—ã€å®Œå…¨ãªäº’æ›æ€§ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚(ä¾‹ãˆã°layoutãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“)

```typescript
import { defineConfig } from 'astro/config';
export default defineConfig({
  legacy: {
    collections: true
  }
});
```

### Sever Islands

Astro v5 ã§ã¯ã€ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¾ã§æ‹¡å¼µã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šé«˜æ€§èƒ½ãªé™çš„HTMLã¨å‹•çš„ãªã‚µãƒ¼ãƒãƒ¼ç”Ÿæˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«`server:defer`ã‚’ä»˜ä¸ã™ã‚‹ã¨ã€ã¾ãšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã¨å·®ã—æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚

ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆã®æŠ‘åˆ¶ã«ã‚‚å½¹ç«‹ã¡ãã†ã§ã™ã€‚

```astro
---
import Avatar from '../components/Avatar.astro';
import GenericAvatar from '../components/GenericAvatar.astro';
---
<Avatar server:defer>
  <GenericAvatar slot="fallback" />
</Avatar>
```

ã•ã‚‰ãªã‚‹æƒ…å ±ã¯[å…¬å¼ã‚µã‚¤ãƒˆ](https://docs.astro.build/ja/guides/server-islands/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Simplified prerendering

Astro v5 ã§ã¯`static`ã¨`hybrid`ã®å‡ºåŠ›å½¢å¼ãŒ`static`ã«çµ±åˆã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯ã€actionã‚„ [Server Islands](#sever-islands)ã®ä½¿ç”¨ã«å¿…è¦ãªè¨­å®šãŒè¤‡é›‘åŒ–ã—ãŸãŸã‚ã€ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«è¡Œã‚ã‚Œã¾ã—ãŸã€‚

`static`ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ã§ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ãŒé™çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ãŒã€`export const prerender = false`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å‹•çš„ãªãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### å‹ä»˜ãç’°å¢ƒå¤‰æ•°

ç’°å¢ƒå¤‰æ•°ã«zodã‚’ä½¿ç”¨ã—ã¦å‹ã‚’ä»˜ã‘ãŸã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä½¿ç”¨ã§ãã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ¶é™ã—ãŸã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```typescript
// astro.config.mjs
import { defineConfig, envField } from 'astro/config'

export default defineConfig({
  env: {
    schema: {
      API_URL: envField.string({ context: "client", access: "public", optional: true }),
      PORT: envField.number({ context: "server", access: "public", default: 4321 }),
      API_SECRET: envField.string({ context: "server", access: "secret" }),
    }
  }
})
```

åˆ©ç”¨ã™ã‚‹éš›ã¯`astro/client`ã‹`astro/server`ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã¯`astro/client`ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```typescript
import { API_URL } from 'astro/client'
import { PORT, API_SECRET } from 'astro/server'
```

è©³ã—ãã¯[å…¬å¼ã‚µã‚¤ãƒˆ](https://docs.astro.build/en/guides/environment-variables/#type-safe-environment-variables)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Vite 6

ã¤ã„å…ˆæ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ Vite 6 ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## ãã®ä»–å€‹äººçš„ã«æ³¨ç›®ã—ã¦ã„ã‚‹æ–°æ©Ÿèƒ½

Astro Blog ã§ã¯å–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã„ãªã„ã‚‚ã®ã®ã€å€‹äººçš„ã«æ³¨ç›®ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚

### `import.meta.env.MODE`

`--mode`ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§`import.meta.env.MODE`ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯`astro.config.mjs`ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã§ã€é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹è¨­å®šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
`astro dev`ã§`"development"`ã€`astro build`ã§`"production"`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šã•ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€`.env.development`ã‚„`.env.production`ã®åˆ‡ã‚Šæ›¿ãˆã‚‚è¡Œã‚ã‚Œã‚‹ã®ã§ã€ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### tsconfig.jsonã®å¤‰æ›´

AstroãŒæ¨å¥¨ã™ã‚‹`tsconfig.json`ã®è¨­å®šãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚

å¾“æ¥ã¯`env.d.ts`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚

```typescript
/// <reference types="astro/client" />
/// <reference path="../.astro/env.d.ts" />
/// <reference path="../.astro/actions.d.ts" />
```

Astro v5 ã§ã¯`tsconfig.json`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```diff
  {
    "extends": "astro/tsconfigs/base",
+   "include": [".astro/types.d.ts", "**/*"],
+   "exclude": ["dist"]
  }
```

### Markdownã®æ”¹å–„

Markdownã§ã®ç”»åƒã®èª­ã¿è¾¼ã¿ãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚åŒã˜ãƒ•ã‚©ãƒ«ãƒ€å†…ã«é…ç½®ã•ã‚ŒãŸç”»åƒã«å¯¾ã—ã¦æ¨™æº–æ§‹æ–‡ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```markdown
<!-- å¾“æ¥ -->
![alt text](./image.png)

<!-- Astro v5 -->
![alt text](image.png)
```

### Content Collection ã® JSON Schema ç”Ÿæˆ

Content Collection ã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰JSON Schemaã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã‚’ã‚¨ãƒ‡ã‚£ã‚¿ãªã©ã«ç™»éŒ²ã™ã‚‹ã“ã¨ã§JSONã®å…¥åŠ›ãŒè£œå®Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**.vscode/settings.json**
```json
{  
  "json.schemas": [
    {
      "fileMatch": ["/src/content/authors/*.json"],
      "url": "/.astro/collections/authors.schema.json"
    },
  ]
}
```

ã¾ãŸã€Content Intellisenseã¨ã„ã†æ©Ÿèƒ½ã‚‚å®Ÿé¨“çš„ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨`.md`, `.mdx`, `.mdoc`ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§IntellisenseãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

### CSRF Protection

`Origin` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€CSRFæ”»æ’ƒã‚’é˜²ããŸã‚ã®æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

### Astro Integration åŒå£«ã®é€šä¿¡

Astro Integration åŒå£«ã®ç›¸äº’å‘¼ã³å‡ºã—ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¤‡æ•°ã®Astro Integration ã‚’çµ„ã¿åˆã‚ã›ã‚‹IntegrationãŒä½œæˆã§ãã¾ã™ã€‚

### langAlias for shiki

Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æä¾›ã—ã¦ã„ã‚‹shikiã®è¨­å®šã«`langAlias`ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`javascript`ã‚’`cjs`ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
// astro.config.mjs
import { defineConfig } from 'astro/config';

export default defineConfig({
  markdown: {
    shikiConfig: {
      langAlias: {
        cjs: 'javascript',
      },
    },
  },
});
```

## Experimental features

ç¾æ™‚ç‚¹ (2024/12/8) ã§ã¯ã¾ã å®Ÿé¨“çš„ãªæ©Ÿèƒ½ã¨ã—ã¦ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚

### Container API

Container APIã‚’ä½¿ã†ã¨ Astro ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å€‹åˆ¥ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

å°†æ¥çš„ã«ã¯Serverå´ã§ã‚‚åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹äºˆå®šã ãã†ã§ã™ã€‚

https://docs.astro.build/en/reference/container-reference/

### SVG Component

svgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚ã‚‹æ©Ÿèƒ½ã§ã™ã€‚è‰²ã‚„ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã§ãã¾ã™ã€‚
    
```astro
---
import Logo from '../assets/logo.svg';
---

<Logo width={64} height={64} fill="currentColor" />
```

`size`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€`width`ã¨`height`ã‚’åŒæ™‚ã«æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

https://docs.astro.build/en/reference/experimental-flags/svg/

### Responsive Images

`<Image />`ã¨`<Picture />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã—ãŸç”»åƒã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªç”»åƒã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

```astro
---
import { Image, Picture } from 'astro:assets';
import myImage from '../assets/my_image.png';
---
<Image src={myImage} alt="A description of my image." layout='responsive' width={800} height={600} />
<Picture src={myImage} alt="A description of my image." layout='full-width' formats={['avif', 'webp', 'jpeg']} />
```

## ã¾ã¨ã‚

ä»¥ä¸Šå€‹äººçš„ã«æ°—ã«ãªã£ãŸAstro v5ã®æ–°æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã¾ã ã¾ã å®Ÿé¨“çš„ãªæ©Ÿèƒ½ã‚‚å¤šã„ã®ã§ã€ã“ã‚Œã‹ã‚‰ã®ç™ºå±•ãŒæ¥½ã—ã¿ã§ã™ã€‚
